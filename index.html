<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>제주 맛집 AR</title>

  <!-- 캐시 무효화 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ✅ GitHub Pages 상대경로 깨짐 방지 -->
  <base href="https://bible6392-coder.github.io/jeju-ar-map/">

  <style>
    body { margin:0; background:#000; color:#fff; font-family:sans-serif; text-align:center; }
    .badge { position:fixed; top:10px; left:10px; color:#0f0; font:12px/1 monospace; z-index:9999 }
    .wrap { height:100vh; display:flex; align-items:flex-end; justify-content:center; }
    .controls { display:flex; gap:20px; margin-bottom:40px; }
    .btn { width:120px; height:50px; border:none; border-radius:12px; font-size:16px; cursor:pointer; }
    .btn-primary { background:#ff6b6b; color:#fff; }
    .btn-gray { background:#eee; color:#000; }
  </style>
</head>
<body>
  <div class="badge">v-2025-08-26-디버그</div>

  <div class="wrap">
    <div class="controls">
      <button id="openArBtn" class="btn btn-primary">📷 네이티브 AR 열기</button>
      <button id="locBtn" class="btn btn-gray">📍 위치</button>
    </div>
  </div>

  <!-- Capacitor 브리지 -->
  <script src="capacitor.js"></script>
  <script>
    // ✅ 디버그: JS 에러를 alert로 표시
    window.onerror = (msg, src, line, col, err) => {
      alert("JS 에러: " + msg + "\\n@" + src + ":" + line + ":" + col);
    };
    console.log("✅ index.html loaded");

    function waitCapacitorReady(timeout = 4000) {
      return new Promise((resolve) => {
        if (window.Capacitor?.Plugins) return resolve(true);
        const start = Date.now();
        const id = setInterval(() => {
          if (window.Capacitor?.Plugins) { clearInterval(id); resolve(true); }
          else if (Date.now() - start > timeout) { clearInterval(id); resolve(false); }
        }, 50);
      });
    }

    async function init() {
      const ready = await waitCapacitorReady();
      if (!ready) {
        alert('Capacitor 준비 실패');
        return;
      }

      const openBtn = document.getElementById('openArBtn');
      const locBtn  = document.getElementById('locBtn');

      openBtn?.addEventListener('click', async () => {
        try {
          const Ar = window.Capacitor.Plugins.ArLauncher;
          if (!Ar) return alert('ArLauncher 플러그인 없음');
          const res = await Ar.open();
          console.log('ArActivity launched:', res);
        } catch (e) {
          alert('네이티브 실행 실패: ' + (e.message || e));
        }
      });

      locBtn?.addEventListener('click', async () => {
        try {
          const G = window.Capacitor.Plugins.Geolocation;
          if (!G) return alert('Geolocation 플러그인 없음');
          const pos = await G.getCurrentPosition();
          alert(`위치: ${pos.coords.latitude}, ${pos.coords.longitude}`);
        } catch (e) {
          alert('위치 실패: ' + (e.message || e));
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
