<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ì œì£¼ ë§›ì§‘ AR</title>
  <style>
    html,body { margin:0; padding:0; height:100%; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; }
    #camera-view { position:relative; width:100vw; height:100vh; background:#000; overflow:hidden; }
    /* toBack:trueì¼ ë•Œ í”„ë¦¬ë·°ê°€ ë’¤ì— ê¹”ë¦¬ê³  ë²„íŠ¼ì€ ìœ„ì— ë– ìš” */
    .bottom-controls { position:fixed; left:50%; bottom:24px; transform:translateX(-50%); display:flex; gap:16px; z-index:10; }
    .control-btn { width:64px; height:64px; border:none; border-radius:50%; font-size:26px; cursor:pointer; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.25); }
    .capture-btn { background:#ff6b6b; color:#fff; }
    .toast { position:fixed; left:50%; top:80px; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:14px; font-size:14px; z-index:20; display:none; }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <div id="camera-view">
    <!-- ì—¬ê¸°ì— ì´í›„ AR ë§ˆì»¤/ì˜¤ë²„ë ˆì´ë¥¼ ììœ ë¡­ê²Œ ì˜¬ë¦¬ë©´ ë©ë‹ˆë‹¤ -->
    <div class="bottom-controls">
      <button id="helpBtn" class="control-btn" title="ë„ì›€ë§">â„¹ï¸</button>
      <button id="flashBtn" class="control-btn" title="í”Œë˜ì‹œ">ğŸ’¡</button>
      <button id="captureBtn" class="control-btn capture-btn" title="ì‚¬ì§„ì°ê¸°">ğŸ“·</button>
      <button id="locBtn" class="control-btn" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <!-- âœ… Capacitor ë„¤ì´í‹°ë¸Œ ë¸Œë¦¬ì§€ (ì•±ì´ ì œê³µ) -->
  <script src="capacitor.js"></script>

  <!-- âœ… ì „ì—­ ë¸Œë¦¬ì§€ë¡œ í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš© (Capacitor 6) -->
  <script>
    const showToast = (msg, ms=1500) => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    };

    // ì „ì—­ ë¸Œë¦¬ì§€ì—ì„œ í”ŒëŸ¬ê·¸ì¸ ì°¸ì¡°
    const P = (window.Capacitor && window.Capacitor.Plugins) ? window.Capacitor.Plugins : {};
    const Camera          = P.Camera;           // ê¶Œí•œ ìš”ì²­ìš©
    const Geolocation     = P.Geolocation;
    const Filesystem      = P.Filesystem;
    const CameraPreview   = P.CameraPreview;    // ì‹¤ì‹œê°„ í”„ë¦¬ë·°/ì´¬ì˜
    let flashOn = false;

    async function requestAllPermissions() {
      if (!window.Capacitor?.isNativePlatform?.()) return;
      try {
        await Camera?.requestPermissions?.();        // CAMERA
        await Geolocation?.requestPermissions?.();   // LOCATION
      } catch (e) { console.error('ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', e); }
    }

    async function startPreview() {
      if (!CameraPreview) return;
      try {
        await CameraPreview.start({
          position: 'rear',
          parent: 'camera-view',   // í”„ë¦¬ë·°ê°€ ê¹”ë¦´ ì»¨í…Œì´ë„ˆ id
          className: 'cameraPreview',
          toBack: true,            // í”„ë¦¬ë·°ë¥¼ ë’¤ë¡œ (UIëŠ” ìœ„ì—)
          enableHighResolution: true
        });
      } catch (e) {
        console.error('í”„ë¦¬ë·° ì‹œì‘ ì‹¤íŒ¨:', e);
        showToast('ì¹´ë©”ë¼ í”„ë¦¬ë·° ì‹œì‘ ì‹¤íŒ¨');
      }
    }

    async function stopPreview() {
      try { await CameraPreview?.stop?.(); } catch(_) {}
    }

    async function toggleFlash() {
      if (!CameraPreview?.setFlashMode) return;
      try {
        flashOn = !flashOn;
        await CameraPreview.setFlashMode({ flashMode: flashOn ? 'on' : 'off' });
        showToast(flashOn ? 'í”Œë˜ì‹œ ON' : 'í”Œë˜ì‹œ OFF');
      } catch (e) { console.error(e); }
    }

    async function capturePhoto() {
      try {
        // CameraPreview.captureëŠ” base64 ë°˜í™˜
        const shot = await CameraPreview.capture({ quality: 85 });
        const base64 = shot?.value || shot?.data;   // í”ŒëŸ¬ê·¸ì¸ ë²„ì „ì— ë”°ë¼ í‚¤ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
        if (!base64) throw new Error('no image');

        const fileName = `photo_${Date.now()}.jpeg`;
        await Filesystem.writeFile({
          path: fileName,
          data: base64,
          directory: 'DOCUMENTS'
        });
        showToast(`ğŸ“¸ ì €ì¥ ì™„ë£Œ: ${fileName}`);
      } catch (e) {
        console.error('ì´¬ì˜/ì €ì¥ ì‹¤íŒ¨:', e);
        showToast('ì´¬ì˜/ì €ì¥ ì‹¤íŒ¨');
      }
    }

    async function getLocation() {
      try {
        const pos = await Geolocation.getCurrentPosition();
        const { latitude, longitude } = pos.coords || {};
        showToast(`ìœ„ì¹˜: ${latitude?.toFixed(5)}, ${longitude?.toFixed(5)}`);
        // TODO: ì—¬ê¸°ì„œ POIì™€ ê±°ë¦¬/ë°©ìœ„ê° ê³„ì‚°í•´ AR ì˜¤ë²„ë ˆì´ ê°±ì‹ 
      } catch (e) {
        console.error('ìœ„ì¹˜ ì‹¤íŒ¨:', e);
        showToast('ìœ„ì¹˜ ê¶Œí•œ í•„ìš”');
      }
    }

    function showHelp() {
      alert([
        'ì œì£¼ ë§›ì§‘ AR',
        '- ë°°ê²½: ì‹¤ì‹œê°„ ì¹´ë©”ë¼ í”„ë¦¬ë·°',
        '- ğŸ“·: ìº¡ì²˜ í›„ ê¸°ê¸°ì— ì €ì¥',
        '- ğŸ’¡: í”Œë˜ì‹œ í† ê¸€',
        '- ğŸ“: í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ',
        'GitHub Pagesì— íŒŒì¼ ìˆ˜ì • ì‹œ ì•±ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.'
      ].join('\n'));
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // ë„¤ì´í‹°ë¸Œ í™˜ê²½ì—ì„œë§Œ ë™ì‘
      if (window.Capacitor?.isNativePlatform?.()) {
        await requestAllPermissions();
        await startPreview();
      }
      // ë²„íŠ¼ ë°”ì¸ë”©
      document.getElementById('helpBtn')?.addEventListener('click', showHelp);
      document.getElementById('flashBtn')?.addEventListener('click', toggleFlash);
      document.getElementById('captureBtn')?.addEventListener('click', capturePhoto);
      document.getElementById('locBtn')?.addEventListener('click', getLocation);
    });

    // ì•± ì¢…ë£Œ/ë°±ê·¸ë¼ìš´ë“œ ëŒ€ë¹„ë¡œ ì •ë¦¬ (ì„ íƒ)
    document.addEventListener('pause', stopPreview);
    document.addEventListener('resume', () => {
      if (window.Capacitor?.isNativePlatform?.()) startPreview();
    });
  </script>
</body>
</html>
